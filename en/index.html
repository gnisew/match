<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¥·çƒè¡£è¡Œè‹±èªéŠæˆ²</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #game-container {
            text-align: center;
        }
		#game-board {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 10px;
			margin-top: 20px;
		}
		/* æ‰‹æ©Ÿç‰ˆé¢èª¿æ•´ */
		@media (max-width: 600px) {
			#game-board {
				grid-template-columns: repeat(2, 1fr);
			}
			.card {
			   padding: 15px 10px !important;
			   font-size: 20px !important;
			}
		}
        .card:hover {
            background-color: #e0e0e0;
        }
        button {
            margin: 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        #range-select {
            margin: 10px;
            padding: 13px 15px;
            font-size: 16px;
        }
        .card {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
			font-size: 24px;
			user-select: none;
        }
        .card.flipped {
            background-color: #ffff99;
        }
        .card.matched {
            background-color: #e0e0e0;
        }
		.pair-button {
			background-color: #f0f0f0;
			border: 1px solid #ccc;
			color: #333;
			padding: 10px 20px;
			margin: 5px;
			cursor: pointer;
			border-radius: 5px;
			transition: all 0.3s ease;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
		}

		.pair-button:hover {
			background-color: #e0e0e0;
			box-shadow: 0 4px 8px rgba(0,0,0,0.15);
		}

		.pair-button.selected {
			background-color: #4a90e2;
			color: white;
			border-color: #3a80d2;
			box-shadow: 0 2px 4px rgba(0,0,0,0.2);
		}

        .vowel { color: #AA0000; }
        .semivowel { color: #4B0082; }
        .consonant { color: #0000AA; }
		.kk-bracket {
		    color: #555 !important;
		}
		#word-list-table .clickable .kk-bracket {
			color: #555 !important;
		}

        #return-button {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 16px;
            cursor: pointer;
            background: none;
            border: none;
        }
        #stats {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 16px;
            display: none;
        }
        @keyframes jumpAnimation {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes shakeAnimation {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .jump {
            animation: jumpAnimation 0.3s ease;
        }

        .shake {
            animation: shakeAnimation 0.3s ease;
        }

#custom-wordlist-container {
    position: fixed; 
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.15);
    z-index: 1000;
    max-height: 90vh;
    width: 90%;
    max-width: 500px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.custom-wordlist-scroll {
    flex-grow: 1;
    overflow-y: auto;
    margin-top: 20px;
    padding-right: 10px;
    max-height: calc(90vh - 300px); 
}

#custom-wordlist {
    width: 95%;
    resize: vertical;
    min-height: 100px;
    max-height: 200px;
    overflow-y: auto;
    border: 0.5px solid #ccc;
    border-radius: 5px;
    padding: 10px;
    font-size: 14px;
}

.correctAnswerElement{
    user-select: none;
    font-size: 36px;
}

#custom-wordlist {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

#custom-wordlist {
    transform: translateZ(0);
}

.button-group {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
}

.button-group button {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    background-color: #4a90e2;
    color: white;
    cursor: pointer;
    transition: background-color 0.3s;
}

.button-group button:hover {
    background-color: #3a80d2;
}

.wordlist-item {
    background-color: #f5f5f5;
    border-radius: 5px;
    padding: 0px 10px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.wordlist-name {
    font-weight: bold;
}

.wordlist-actions button {
    padding: 5px 10px;
    margin-left: 5px;
    border: none;
    border-radius: 3px;
    background-color: #e0e0e0;
    cursor: pointer;
    transition: background-color 0.3s;
}

.wordlist-actions button:hover {
    background-color: #d0d0d0;
}

h1 {
	user-select: none;
}

h2 {
    margin-top: 0;
    margin-bottom: 15px;
    color: #333;
	user-select: none;
}
		#saved-wordlists {
			margin-top: 20px;
		}

		#custom-wordlist-btn-container {
			width: 100%;
			text-align: center;
			margin: 10px 0;
		}

		#show-custom-wordlist-btn {
			display: inline-block;
		}


        #view-words-btn {
            margin-left: 10px;
        }
        
        #word-list-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

		#word-list-table {
			width: 100%;
			border-collapse: collapse;
		}

		#word-list-table th, #word-list-table td {
			border: 1px solid #ddd;
			padding: 8px;
			text-align: left;
		}

		#word-list-table th {
			background-color: #f2f2f2;
		}

		#word-list-table tr:nth-child(even) {
			background-color: #f9f9f9;
		}


		#word-list-table .clickable {
			cursor: pointer;
			color: #0000FF;
			text-decoration: none;
		}

		#saved-wordlists {
			margin-top: 20px;
		}
		.wordlist-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 10px;
		}
		.wordlist-name {
			cursor: pointer;
		}

		#game-board {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			height: 100%;
		}

		#game-board {
			margin-bottom: 20px;
			text-align: center;
			word-break: break-all;
		}

		.word-display {
			font-size: 36px;
			margin-bottom: 20px;
			text-align: center;
			word-break: break-all;
		}
		#game-board input {
			font-size: 36px;
			padding: 10px 15px;
			border: 2px solid #ccc;
			border-radius: 5px;
			text-align: center;
			width: 300px;
			max-width: 80%;
			outline: none;
			transition: border-color 0.3s;
		}

		#game-board input:focus {
			border-color: #4a90e2;
		}



input::placeholder {
    color: #CCCCCC;
    opacity: 1;
}

input::-webkit-input-placeholder { 
    color: #CCCCCC;
}
input::-moz-placeholder { 
    color: #CCCCCC;
}
input:-ms-input-placeholder {
    color: #CCCCCC;
}
input:-moz-placeholder {
    color: #CCCCCC;
}




    </style>
</head>
<body>
    <div id="game-container">
        <button id="return-button" style="display: none;" onclick="returnToSetup()">X</button>
        <div id="stats">
            æ™‚é–“ï¼š<span id="time">00:00</span><br>
            æ­£ç¢ºç‡ï¼š<span id="accuracy">100%</span>
        </div>
        <h1>ğŸ¥·çƒè¡£è¡Œè‹±èªéŠæˆ²</h1>

		<div id="custom-wordlist-container" style="display: none;">
			<span class="close" onclick="closeCustomWordlist()">&times;</span>
			<h2>è¼¸å…¥è‡ªè¨‚èªè©è¡¨</h2>
			<textarea id="custom-wordlist" placeholder="è«‹è¼¸å…¥è‡ªè¨‚èªè©è¡¨ï¼Œæ ¼å¼ç‚ºï¼šè‹±æ–‡\tä¸­æ–‡\næ¯è¡Œä¸€å€‹å–®è©å°"></textarea>
			<div class="button-group">
				<button onclick="clearCustomWordlist()">æ¸…é™¤</button>
				<button onclick="saveCustomWordlist()">å„²å­˜</button>
				<button onclick="closeCustomWordlist()">é—œé–‰</button>
				<button onclick="confirmCustomWordlist()">ç¢ºèª</button>
			</div>
			<div class="custom-wordlist-scroll">
				<div id="saved-wordlists"></div>
			</div>
		</div>

        <div id="setup">
			<div id="custom-wordlist-btn-container">
				<button id="show-custom-wordlist-btn" onclick="showCustomWordlist()">è‡ªè¨‚èªè©è¡¨</button>
			</div>
            <h2>é¸æ“‡é…å°é …ç›®ï¼š</h2>			

            <h2>é¸æ“‡ç¯„åœï¼š</h2>			
            <select id="range-select" onchange="updateSelectedRange()">
                <option value="all">å…¨éƒ¨</option>
            </select>
            <button onclick="startGame()">é–‹å§‹é…å°</button>
			<button onclick="startSpellingGame()">é–‹å§‹æ‹¼å­—</button>
			<button id="view-words-btn" onclick="showWordList()">æª¢è¦–èªè©</button>
        </div>
        <div id="game-board" style="display: none;"></div>
        <div id="game-controls" style="display: none;">
            <button onclick="continueGame()">ç¹¼çºŒ</button>
            <button onclick="returnToSetup()">è¿”å›</button>
        </div>


        <div id="word-list-modal">
            <div class="modal-content">
                <span class="close" onclick="closeWordList()">&times;</span>
                <h2>è©è¡¨</h2>
                <table id="word-list-table">
                    <thead>
                        <tr>
                            <th>è‹±æ–‡</th>
                            <th>KKéŸ³æ¨™</th>
                            <th>ä¸­æ–‡é‡‹ç¾©</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- è¡¨æ ¼å…§å®¹å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
    const localStorage = "enc";
    const data = `    
æ—¥æœŸ	è‹±æ–‡	ä¸­æ–‡é‡‹ç¾©	KKéŸ³æ¨™
1	sausage	é¦™è…¸;è‡˜è…¸	['sÉ”sÉªÊ¤]
1	goat	å±±ç¾Š	[goÊŠt]
1	spicy	è¾›è¾£çš„	['spaÉªsi]
1	pizza	æŠ«è–©	['piÊ¦É™]
1	ketchup	ç•ªèŒ„é†¬	['kÉ›Ê§É™p]
2	pleasant	ä»¤äººæ„‰å¿«çš„	['plÉ›zÉ™nt]
2	side dish	é…èœ;å°èœ	[saÉªd dÉªÊƒ]
2	fries	ç‚¸è–¯æ¢	[fraÉªz]
2	pick up	è³¼è²·	[pÉªk ÊŒp]
2	onion	æ´‹è”¥	['ÊŒnjÉ™n]
3	large	å¤§çš„	[lÉ‘rÊ¤]
3	marvelous	çµ•ç¾çš„;å¥½æ¥µçš„	['mÉ‘rvÉ™lÉ™s]
3	church	æ•™å ‚	[Ê§ÉÊ§]
3	square	å»£å ´	[skwÉ›r]
3	move	(ä½¿)ç§»å‹•	[muv]
4	festival	ç¯€æ…¶;ç¯€æ—¥	['fÉ›stÉªvÉ™l]
4	band	æ¨‚éšŠ;æ¨‚åœ˜	[bÃ¦nd]
4	wall	ç‰†	[wÉ”l]
4	surround	åœç¹	[sÉ™'raÊŠnd]
4	market	å¸‚é›†;å¸‚å ´	['mÉ‘rkÉªt]
7	centimeter	å…¬åˆ†	['sÉ›ntÉ™ËŒmitÉ™r]
7	weight	é‡é‡	[weÉªt]
7	gram	å…¬å…‹	[grÃ¦m]
7	eagle	é·¹	['igÉ™l]
7	goose	éµ	[gus]
8	fence	æ¬„æ†;åœç±¬	[fÉ›ns]
8	focus	(ä½¿)èšç„¦	['foÊŠkÉ™s]
8	point	åœ°é»	[pÉ”Éªnt]
8	quickly	å¿«é€Ÿåœ°	['kwÉªkli]
8	path	é“è·¯;é€šè·¯	[pÃ¦Î¸]
9	guy	äºº	[gaÉª]
9	train	è¨“ç·´	[treÉªn]
9	fit	å¥åº·çš„;å¥ç¾çš„	[fÉªt]
9	test	è€ƒé©—;æ¸¬è©¦	[tÉ›st]
9	mind	å¿ƒæ™º	[maÉªnd]
10	sick	ç”Ÿç—…çš„	[sÉªk]
10	cook	çƒ¹ç…®;æ–™ç†	[kÊŠk]
10	wash	æ¸…æ´—	[wÉ‘Êƒ]
10	temperature	æº«åº¦	['tÉ›mpÉ™rÉ™Ê§]
10	refrigerator	å†°ç®±	[rÉª'frÉªÊ¤É™ËŒreÉªtÉ™r]
11	pale	è’¼ç™½çš„(è‡‰è‰²æˆ–è†šè‰²)	[peÉªl]
11	buffet	è‡ªåŠ©é¤å»³;è‡ªåŠ©é¤	[bÉ™'feÉª]
11	stomachache	èƒƒç—›;è‚šå­ç—›	['stÊŒmÉ™kËŒeÉªk]
11	lucky	å¹¸é‹çš„	['lÊŒki]
11	recover	æ¢å¾©å¥åº·	[rÉª'kÊŒvÉ™r]
14	hobby	å—œå¥½	['hÉ‘bi]
14	star	æ˜Ÿæ˜Ÿ	[stÉ‘r]
14	full	å……æ»¿çš„	[fÊŠl]
14	billion	åå„„	['bÉªljÉ™n]
14	count	æ•¸ç®—	[kaÊŠnt]
15	borrow	å€Ÿå…¥	['bÉ‘roÊŠ]
15	interested	æ„Ÿèˆˆè¶£çš„	['ÉªntrÉªstÉªd]
15	tip	è¨£ç«…;æ’‡æ­¥	[tÉªp]
15	cloudy	å¤šé›²çš„;é™°å¤©çš„	['klaÊŠdi]
15	moon	æœˆäº®	[mun]
16	die	éä¸–,æ­»äº¡	[daÉª]
16	bag	è¢‹å­	[bÃ¦g]
16	wrong	éŒ¯èª¤çš„	[rÉ”Å‹]
16	accept	æ¥å—	[Ã¦k'sÉ›pt]
16	cafeteria	å“¡å·¥/å­¸æ ¡é¤å»³	[ËŒkÃ¦fÉª'tÉªriÉ™]
17	creative	æœ‰å‰µæ„çš„	[kriËˆeÉªtÉªv]
17	communicate	æºé€šï¼›äº¤æµ	[kÉ™ËˆmjunÉªkeÉªt]
17	cellphone	æ‰‹æ©Ÿ	[ËˆsÉ›lfoÊŠn]
17	light	å…‰ï¼›å…‰ç·š	[laÉªt]
17	scientist	ç§‘å­¸å®¶	[ËˆsaÉªÉ™ntÉªst]
18	microwave	å¾®æ³¢çˆ	[ËˆmaÉªkrÉ™weÉªv]
18	heat up	åŠ ç†±	[hit ÊŒp]
18	seat belt	å®‰å…¨å¸¶	[sit bÉ›lt]
18	airplane	é£›æ©Ÿ	[ËˆÉ›rpleÉªn]
18	medicine	é†«å­¸ï¼›é†«è¡“	[ËˆmÉ›dÉ™sÉªn]
21	clothes	è¡£æœ	[kloÊŠÃ°z]
21	fill	(ä½¿)è£æ»¿	[fÉªl]
21	tight	ç·Šåœ°	[taÉªt]
21	steam	è’¸æ°£	[stim]
21	wrinkle	çšºè¤¶ï¼›çšºç´‹	[ËˆrÉªÅ‹kÉ™l]
22	sleepy	çå€¦çš„ï¼›æ‰“çŒç¡çš„	[Ëˆslipi]
22	ice	å†°ï¼›å†°å¡Š	[aÉªs]
22	quick	çŸ­æš«çš„ï¼›å¿«é€Ÿçš„	[kwÉªk]
22	wake up	æ¸…é†’ã€é†’ä¾†	[ËˆweÉªk ÊŒp]
22	energy	ç²¾åŠ›ã€èƒ½é‡	[ËˆÉ›nÉšÊ¤i]
23	habit	ç¿’æ…£	[ËˆhÃ¦bÉªt]
23	meal	ä¸€é¤é£¯	[mil]
23	soda	æ±½æ°´	[ËˆsoÊŠdÉ™]
23	bedroom	è‡¥å®¤	[ËˆbÉ›drum]
23	video	å½±ç‰‡ï¼›éŒ„å½±	[ËˆvÉªdioÊŠ]
24	private	ç§äººçš„ï¼›ç§æœ‰çš„	[ËˆpraÉªvÉªt]
24	own	è‡ªå·±çš„	[oÊŠn]
24	cheap	ä¾¿å®œçš„ï¼›ä¸è²´çš„	[Ê§ip]
24	individual	å€‹äººçš„ï¼›å€‹é«”çš„	[ËŒÉªndÉ™ËˆvÉªÊ¤uÉ™l]
24	slow	æ…¢çš„	[sloÊŠ]
25	flow	æµå‹•	[floÊŠ]
25	roast	çƒ˜ç„™ï¼›çƒ¤	[roÊŠst]
25	sort	æŒ‘é¸ï¼›åˆ†é¡	[sÉ”rt]
25	perfect	å®Œç¾çš„	[ËˆpÉœrfÉªkt]
25	affect	å½±éŸ¿	[É™ËˆfÉ›kt]
28	meeting	æœƒè­°ï¼›æœƒé¢	[ËˆmitÉªÅ‹]
28	enough	è¶³å¤ çš„ï¼›å……è¶³çš„	[ÉªËˆnÊŒf]
28	moment	ç‰‡åˆ»ï¼›æ™‚åˆ»	[ËˆmoÊŠmÉ™nt]
28	past	éäº†ï¼›è¶…é(æ™‚é–“)	[pÃ¦st]
28	quarter	åäº”åˆ†é˜ï¼›ä¸€åˆ»é˜	[ËˆkwÉ”rtÉ™r]
29	on time	æº–æ™‚	[É‘n taÉªm]
29	popcorn	çˆ†ç±³èŠ±	[ËˆpÉ‘pkÉ”rn]
29	any time	ä¸å®¢æ°£	[ËˆÉ›ni taÉªm]
29	make time	é¨°å‡ºæ™‚é–“	[meÉªk taÉªm]
29	now and then	å¶çˆ¾	[naÊŠ Ã¦nd Ã°É›n]
30	hen	æ¯é›	[hÉ›n]
30	farm	è¾²å ´	[fÉ‘rm]
30	plant	ç¨®æ¤	[plÃ¦nt]
30	golden	é‡‘è‰²çš„	[ËˆÉ¡oldÉ™n]
30	cut	å‰ªã€åˆ‡	[kÊŒt]
31	pile	(ä¸€)å †ï¼›ç–Š	[paÉªl]
31	mix	(ä½¿)æ··åˆï¼›æ‹Œåˆ	[mÉªks]
31	pan	çƒ¤ç›¤ï¼›å¹³åº•é‹	[pÃ¦n]
31	smell	æ°£å‘³	[smÉ›l]
31	nothing	æ²’æœ‰äº‹æƒ…ï¼›æ²’æœ‰æ±è¥¿	[ËˆnÊŒÎ¸ÉªÅ‹]
`;


    let startTime;
    let timerInterval;
    let attempts = 0;
    let correctMatches = 0;

    let words = [];
    let dates = [];
    let selectedPair = ['english', 'chinese'];
    let selectedRange = 'all';
    let currentPairs = [];
    let flippedCards = [];
    let usedWords = new Set();

    const rightSound = new Audio('right.mp3');
    const wrongSound = new Audio('wrong.mp3');


let customData = '';

function showCustomWordlist() {
    const container = document.getElementById('custom-wordlist-container');
    container.style.display = 'flex';
    renderSavedWordlists();
    
    // 
    setTimeout(() => {
        const rect = container.getBoundingClientRect();
        if (rect.height > window.innerHeight) {
            container.style.top = '5vh';
            container.style.transform = 'translateX(-50%)';
            container.style.height = '90vh';
        }
    }, 0);
}

function closeCustomWordlist() {
    document.getElementById('custom-wordlist-container').style.display = 'none';
}

function clearCustomWordlist() {
    document.getElementById('custom-wordlist').value = '';
}


function safelyGetFromStorage(key) {
    try {
        if (window.localStorage && typeof window.localStorage.getItem === 'function') {
            return window.localStorage.getItem(key);
        }
    } catch (e) {
        console.error('Error accessing localStorage:', e);
    }
    return null;
}

function safelySetToStorage(key, value) {
    try {
        if (window.localStorage && typeof window.localStorage.setItem === 'function') {
            window.localStorage.setItem(key, value);
        }
    } catch (e) {
        console.error('Error setting localStorage:', e);
    }
}

function saveCustomWordlist() {
    const wordlist = document.getElementById('custom-wordlist').value;
    if (wordlist.trim() === '') {
        alert('è«‹è¼¸å…¥èªè©è¡¨å…§å®¹');
        return;
    }
    
    const now = new Date();
    const timestamp = now.getTime();
    const formattedDate = `${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
    const wordlistName = `èªè©è¡¨ ${formattedDate}`;
    
    let wordlists = [];
    const storedData = safelyGetFromStorage('wordlists');
    if (storedData) {
        wordlists = JSON.parse(storedData);
    }
    wordlists.unshift({ name: wordlistName, content: wordlist, timestamp: timestamp });
    safelySetToStorage('wordlists', JSON.stringify(wordlists));
    renderSavedWordlists();
}

function confirmCustomWordlist() {
    customData = document.getElementById('custom-wordlist').value;
    closeCustomWordlist();
    parseData();
}


function renderSavedWordlists() {
    const container = document.getElementById('saved-wordlists');
    let wordlists = [];
    const storedData = safelyGetFromStorage('wordlists');
    if (storedData) {
        wordlists = JSON.parse(storedData);
    }
    container.innerHTML = '';
    wordlists.forEach((wordlist, index) => {
        const item = document.createElement('div');
        item.className = 'wordlist-item';
        item.innerHTML = `
            <span class="wordlist-name" ondblclick="renameWordlist(${index})">${wordlist.name}</span>
            <div class="wordlist-actions">
                <button onclick="restoreWordlist(${index})">é‚„åŸ</button>
                <button onclick="deleteWordlist(${index})">åˆªé™¤</button>
            </div>
        `;
        container.appendChild(item);
    });
}


function restoreWordlist(index) {
    const storedData = safelyGetFromStorage('wordlists');
    if (storedData) {
        const wordlists = JSON.parse(storedData);
        if (wordlists[index]) {
            document.getElementById('custom-wordlist').value = wordlists[index].content;
        }
    }
}

// ä¿®æ”¹ deleteWordlist å‡½æ•¸
function deleteWordlist(index) {
    const storedData = safelyGetFromStorage('wordlists');
    if (storedData) {
        const wordlists = JSON.parse(storedData);
        wordlists.splice(index, 1);
        safelySetToStorage('wordlists', JSON.stringify(wordlists));
        renderSavedWordlists();
    }
}

// ä¿®æ”¹ renameWordlist å‡½æ•¸
function renameWordlist(index) {
    const storedData = safelyGetFromStorage('wordlists');
    if (storedData) {
        const wordlists = JSON.parse(storedData);
        const newName = prompt('è«‹è¼¸å…¥æ–°çš„èªè©è¡¨åç¨±', wordlists[index].name);
        if (newName && newName.trim() !== '') {
            wordlists[index].name = newName.trim();
            safelySetToStorage('wordlists', JSON.stringify(wordlists));
            renderSavedWordlists();
        }
    }
}

// ä¿®æ”¹parseDataå‡½æ•¸ä»¥è™•ç†è‡ªè¨‚æ•¸æ“š
function parseData() {
    const dataToUse = customData || data;  // å¦‚æœæœ‰è‡ªè¨‚æ•¸æ“šï¼Œä½¿ç”¨è‡ªè¨‚æ•¸æ“šï¼Œå¦å‰‡ä½¿ç”¨é»˜èªæ•¸æ“š
    const lines = dataToUse.trim().split('\n');
    const headers = lines[0].split('\t');
    
    // é‡ç½®å…¨å±€è®Šé‡
    words = [];
    dates = [];
    selectedPair = ['english', 'chinese'];  // é»˜èªç‚ºè‹±æ–‡-ä¸­æ–‡
    
    // æª¢æŸ¥æ¨™é¡Œä¸¦æ±ºå®šå¯ç”¨çš„é…å°é¸é …
    const hasKK = headers.includes('KKéŸ³æ¨™');
    const hasDate = headers.includes('æ—¥æœŸ');
    
    // ç”Ÿæˆé…å°é¸é …æŒ‰éˆ•
    const setupDiv = document.getElementById('setup');
    const pairButtons = setupDiv.querySelector('h2:first-of-type').nextElementSibling;
    pairButtons.innerHTML = '<button id="en-ch" class="pair-button selected" onclick="selectPair(\'english\', \'chinese\')">è‹±èª - ä¸­æ–‡</button>';
    
    if (hasKK) {
        pairButtons.innerHTML += '<button id="en-kk" class="pair-button" onclick="selectPair(\'english\', \'kk\')">è‹±èª - KKéŸ³æ¨™</button>';
        pairButtons.innerHTML += '<button id="kk-ch" class="pair-button" onclick="selectPair(\'kk\', \'chinese\')">KKéŸ³æ¨™ - ä¸­æ–‡</button>';
    }
    
    // è™•ç†æ—¥æœŸç¯„åœé¸æ“‡
    const rangeSelect = document.getElementById('range-select');
    rangeSelect.innerHTML = '<option value="all">å…¨éƒ¨</option>';
    
    let currentDate = '';  // ç”¨æ–¼å­˜å„²ç•¶å‰æ—¥æœŸ

    // è§£ææ•¸æ“š
    lines.slice(1).forEach(line => {
        const parts = line.split('\t');
        const wordObj = {};
        
        headers.forEach((header, index) => {
            if (header === 'æ—¥æœŸ' || header === 'åˆ†é¡') {
                if (parts[index].trim() !== '') {
                    currentDate = parts[index];
                    if (!dates.includes(currentDate)) {
                        dates.push(currentDate);
                    }
                }
                wordObj.date = currentDate;
            } else if (header === 'è‹±æ–‡' || header === 'English' || header === 'ENGLISH' || header === 'è‹±èª') {
                wordObj.english = parts[index];
            } else if (header === 'KKéŸ³æ¨™' || header === 'KK' || header === 'KK éŸ³æ¨™') {
                wordObj.kk = parts[index];
            } else if (header === 'ä¸­æ–‡é‡‹ç¾©' || header === 'ä¸­æ–‡' || header === 'Chinese' || header === 'chinese' || header === 'è¯èª' ) {
                wordObj.chinese = parts[index];
            }
        });
        
        if (wordObj.english && wordObj.chinese) {  // ç¢ºä¿è‡³å°‘æœ‰è‹±æ–‡å’Œä¸­æ–‡æ‰æ·»åŠ åˆ°å–®è©åˆ—è¡¨
            words.push(wordObj);
        }
    });
    
    // å¦‚æœæœ‰æ—¥æœŸï¼Œæ·»åŠ åˆ°ä¸‹æ‹‰é¸å–®
    if (hasDate) {
        dates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = date;
            rangeSelect.appendChild(option);
        });
    } else {
        // å¦‚æœæ²’æœ‰æ—¥æœŸã€åˆ†é¡ï¼Œç”Ÿæˆæ¯10å€‹å–®è©ä¸€çµ„çš„é¸é …
        const groups = Math.ceil(words.length / 10);
        for (let i = 0; i < groups; i++) {
            const option = document.createElement('option');
            option.value = `group${i + 1}`;
            option.textContent = `ç¬¬ ${i * 10 + 1} - ${Math.min((i + 1) * 10, words.length)} å€‹å–®è©`;
            rangeSelect.appendChild(option);
        }
    }
}


// æ ¹æ“šé¸æ“‡çš„ç¯„åœç²å–å¯ç”¨å–®è©
function getAvailableWords(selectedRange) {
    if (selectedRange === 'all') {
        return words.filter(word => !usedWords.has(word.english));
    } else if (selectedRange.startsWith('group')) {
        const groupNumber = parseInt(selectedRange.slice(5)) - 1;
        const start = groupNumber * 10;
        const end = Math.min((groupNumber + 1) * 10, words.length);
        return words.slice(start, end).filter(word => !usedWords.has(word.english));
    } else {
        return words.filter(word => word.date === selectedRange && !usedWords.has(word.english));
    }
}

// åœ¨é é¢åŠ è¼‰æ™‚èª¿ç”¨ parseData
window.onload = parseData;

    function populateDateDropdown() {
        const dropdown = document.getElementById('range-select');
        dates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            option.textContent = date;
            dropdown.appendChild(option);
        });
    }

    function selectPair(first, second) {
        selectedPair = [first, second];
        document.querySelectorAll('.pair-button').forEach(btn => btn.classList.remove('selected'));
        document.getElementById(`${first.slice(0,2)}-${second.slice(0,2)}`).classList.add('selected');
    }

    function updateSelectedRange() {
        selectedRange = document.getElementById('range-select').value;
    }

function startGame() {
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game-board').style.display = 'grid';
    document.getElementById('game-controls').style.display = 'none';
    document.getElementById('return-button').style.display = 'block';
    document.getElementById('stats').style.display = 'none';
    document.getElementById('show-custom-wordlist-btn').style.display = 'none';

    startTime = new Date();
    timerInterval = setInterval(updateTimer, 1000);
    attempts = 0;
    correctMatches = 0;

    let availableWords = getAvailableWords(selectedRange);

    if (availableWords.length < 6) {
        usedWords.clear();
        availableWords = getAvailableWords(selectedRange);
    }
    
    currentPairs = shuffleArray(availableWords).slice(0, 6);
    currentPairs.forEach(word => usedWords.add(word.english));
    
    renderBoard();
}

let spellingRound = 1;
let spellingWords = [];

function startSpellingGame() {
	usedWords.clear();
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game-board').style.display = 'flex';
    document.getElementById('game-controls').style.display = 'none';
    document.getElementById('return-button').style.display = 'block';
    document.getElementById('stats').style.display = 'none';
    document.getElementById('show-custom-wordlist-btn').style.display = 'none';

    startTime = new Date();
    timerInterval = setInterval(updateTimer, 1000);
    attempts = 0;
    correctMatches = 0;

    spellingRound = 1;
    spellingWords = shuffleArray(getAvailableWords(selectedRange)).slice(0, 5);
    spellingWords.forEach(word => usedWords.add(word.english));

    renderSpellingGame();
}

function renderSpellingGame() {
    const gameBoard = document.getElementById('game-board');
    gameBoard.innerHTML = '';

    if (spellingRound <= 5) {
        const currentSpellingWord = spellingWords[spellingRound - 1];
        const wordDisplay = document.createElement('div');
        wordDisplay.className = 'word-display';
        wordDisplay.innerHTML = selectedPair[1] === 'chinese' ? currentSpellingWord.chinese : colorizeKKPhonetic(currentSpellingWord.kk);

        const input = document.createElement('input');
        input.type = 'text';
        
        // å‰µå»ºä½”ä½ç¬¦æ–‡å­—
        const answerWord = currentSpellingWord.english;
        const placeholderText = answerWord.split('').map((char, index) => {
            if (index === 0) return char;
            if (char === ' ') return ' ';
            if (char === '-') return '-';
            return '*';
        }).join('');

        input.placeholder = placeholderText;

        input.addEventListener('keyup', (e) => checkSpellingAnswer(e, currentSpellingWord));
        input.onfocus = () => input.select();

        gameBoard.appendChild(wordDisplay);
        gameBoard.appendChild(input);
        input.focus();

        spellingRound++;
    } else {
        showSpellingResults();
    }
}

function showSpellingResults() {
    const now = new Date();
    const diff = now - startTime;
    const seconds = Math.floor((diff % 60000) / 1000);
    const accuracy = Math.round((correctMatches / attempts) * 100);

    const statsDiv = document.createElement('div');
    statsDiv.className = 'stats-display';
    statsDiv.innerHTML = `
        <h2>å›åˆçµæŸ</h2>
        <p>ç”¨æ™‚: ${seconds}ç§’</p>
        <p>æ­£ç¢ºç‡: ${accuracy}%</p>
    `;

    const continueButton = document.createElement('button');
    continueButton.textContent = 'ç¹¼çºŒ';
    continueButton.onclick = startSpellingGame;

    const returnButton = document.createElement('button');
    returnButton.textContent = 'è¿”å›';
    returnButton.onclick = returnToSetup;

    const gameBoard = document.getElementById('game-board');
    gameBoard.innerHTML = '';
    gameBoard.appendChild(statsDiv);
    gameBoard.appendChild(continueButton);
    gameBoard.appendChild(returnButton);

    clearInterval(timerInterval);
}

function checkSpellingAnswer(e, word) {
    if (e.key === 'Enter') {
        const userInput = e.target.value.toLowerCase().trim();
        const correctWord = word.english.toLowerCase().trim();

		if (userInput === correctWord) {
			
            rightSound.play();
            correctMatches++;
            attempts++;         
            setTimeout(() => {
			   e.target.value = '';
			   
               renderSpellingGame();
               e.target.focus();
            }, 10);
        } else {
            wrongSound.play();
            attempts++;
			speakWord(word.english);
			e.target.classList.add('shake');

            // åœ¨è¼¸å…¥æ¡†ä¸‹æ–¹é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
            const inputContainer = e.target.parentElement;
            const correctAnswerElement = document.createElement('div');
            //correctAnswerElement.textContent = `âœ¨ ${word.english}`;
			correctAnswerElement.innerHTML = `âœ¨ ${colorizeEnglishWord(word.english)} âœ¨`;
			
			correctAnswerElement.className = 'correctAnswerElement';
            inputContainer.appendChild(correctAnswerElement);
			

            // æ¸…é™¤æ­£ç¢ºç­”æ¡ˆæç¤ºä¸¦è®“ä½¿ç”¨è€…é‡æ–°è¼¸å…¥
            setTimeout(() => {
                correctAnswerElement.remove();
                e.target.value = '';
                e.target.focus();
            }, 2000);
        }
    }
}





function updateStats() {
    const accuracy = Math.round((correctMatches / attempts) * 100);
    document.getElementById('accuracy').textContent = `${accuracy}%`;
}


    function updateTimer() {
        const now = new Date();
        const diff = now - startTime;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        document.getElementById('time').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function colorizeEnglishWord(word) {
        const vowels = ['a', 'e', 'i', 'o', 'u'];
        const semivowels = ['w', 'y'];
        return word.split('').map(char => {
            if (vowels.includes(char.toLowerCase())) {
                return `<span class="vowel">${char}</span>`;
            } else if (semivowels.includes(char.toLowerCase())) {
                return `<span class="semivowel">${char}</span>`;
            } else {
                return `<span class="consonant">${char}</span>`;
            }
        }).join('');
    }


	function colorizeKKPhonetic(kk) {
		const vowels = ['a', 'É‘', 'Ã¦', 'É›', 'e', 'Éª', 'i', 'É”', 'o', 'ÊŠ', 'u', 'ÊŒ', 'É™', 'Éš', 'É'];
		const semivowels = ['j', 'w'];
		const specialChars = [',', "'", ' '];

		return kk.split('').map(char => {
			if (vowels.includes(char)) {
				return `<span class="vowel">${char}</span>`;
			} else if (semivowels.includes(char)) {
				return `<span class="semivowel">${char}</span>`;
			} else if (char === '[' || char === ']') {
				return `<span class="kk-bracket">${char}</span>`;
			} else if (!specialChars.includes(char)) {
				return `<span class="consonant">${char}</span>`;
			}
			return char;
		}).join('');
	}

    function renderBoard() {
        const gameBoard = document.getElementById('game-board');
        gameBoard.innerHTML = '';
        
        const allCards = [...currentPairs.map(word => ({ word, type: selectedPair[0] })), 
                          ...currentPairs.map(word => ({ word, type: selectedPair[1] }))];
        const shuffledCards = shuffleArray(allCards);
        
        shuffledCards.forEach((card, index) => {
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            if (card.type === 'english') {
                cardElement.innerHTML = colorizeEnglishWord(card.word[card.type]);
            } else if (card.type === 'kk' && selectedPair.includes('kk') && selectedPair.includes('chinese')) {
                cardElement.innerHTML = colorizeKKPhonetic(card.word[card.type]);
            } else {
                cardElement.textContent = card.word[card.type];
            }
            cardElement.dataset.index = index;
            cardElement.onclick = () => flipCard(cardElement, card);
            gameBoard.appendChild(cardElement);
        });
    }

    function flipCard(cardElement, card) {
        if (flippedCards.length < 2 && !flippedCards.some(fc => fc.element === cardElement) && !cardElement.classList.contains('matched')) {
            cardElement.classList.add('flipped');
            flippedCards.push({ element: cardElement, card: card });
            
            if (card.type === 'english') {
                speakWord(card.word.english);
            }
            
            if (flippedCards.length === 2) {
                setTimeout(checkMatch, 10);
            }
        }
    }


    function checkMatch() {
        const [card1, card2] = flippedCards;
        attempts++;
        if (card1.card.word === card2.card.word && card1.card.type !== card2.card.type) {
            card1.element.classList.add('matched', 'jump');
            card2.element.classList.add('matched', 'jump');
            speakWord(card1.card.word.english);
            rightSound.play();
            correctMatches++;

            // ç§»é™¤è·³å‹•å‹•ç•«é¡åˆ¥
            setTimeout(() => {
                card1.element.classList.remove('jump');
                card2.element.classList.remove('jump');
            }, 300);
        } else {
            card1.element.classList.add('shake');
            card2.element.classList.add('shake');
            wrongSound.play();

            // ç§»é™¤æ™ƒå‹•å‹•ç•«é¡åˆ¥ä¸¦ç¿»å›å¡ç‰‡
            setTimeout(() => {
                card1.element.classList.remove('shake', 'flipped');
                card2.element.classList.remove('shake', 'flipped');
            }, 300);
        }
        flippedCards = [];

        if (document.querySelectorAll('.card:not(.matched)').length === 0) {
            clearInterval(timerInterval);
            showStats();
            setTimeout(showGameControls, 10);
        }
    }


    function showStats() {
        const accuracy = Math.round((correctMatches / attempts) * 100);
        document.getElementById('accuracy').textContent = `${accuracy}%`;
        document.getElementById('stats').style.display = 'block';
    }

    function showGameControls() {
        document.getElementById('game-controls').style.display = 'block';
    }

	let currentUtterance = null;

	function speakWord(word) {
		// å¦‚æœæœ‰æ­£åœ¨æ’­æ”¾çš„èªéŸ³ï¼Œå…ˆåœæ­¢å®ƒ;
		if (currentUtterance) {
			window.speechSynthesis.cancel();
		}

		// å‰µå»ºæ–°çš„èªéŸ³
		const utterance = new SpeechSynthesisUtterance(word);
		utterance.lang = 'en-US';

		// ä¿å­˜ç•¶å‰èªéŸ³å¼•ç”¨
		currentUtterance = utterance;

		// æ’­æ”¾æ–°èªéŸ³
		window.speechSynthesis.speak(utterance);

		// èªéŸ³çµæŸå¾Œæ¸…é™¤å¼•ç”¨
		utterance.onend = () => {
			currentUtterance = null;
		};
	}

    function continueGame() {
        document.getElementById('game-controls').style.display = 'none';
        startGame();
    }

	function returnToSetup() {
		document.getElementById('game-board').style.display = 'none';
		document.getElementById('game-controls').style.display = 'none';
		document.getElementById('setup').style.display = 'block';
		document.getElementById('return-button').style.display = 'none';
		document.getElementById('stats').style.display = 'none';
		document.getElementById('show-custom-wordlist-btn').style.display = 'inline-block';
		clearInterval(timerInterval);
		usedWords.clear();
	}

function showWordList() {
    const modal = document.getElementById('word-list-modal');
    const tableBody = document.querySelector('#word-list-table tbody');
    const tableHead = document.querySelector('#word-list-table thead');
    tableBody.innerHTML = '';
    tableHead.innerHTML = '';

    // ç²å–æ•¸æ“šçš„æ¨™é¡Œè¡Œ
    const headers = customData ? customData.trim().split('\n')[0].split('\t') : data.trim().split('\n')[0].split('\t');

    // å‰µå»ºè¡¨é ­
    const headerRow = tableHead.insertRow();
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        headerRow.appendChild(th);
    });

    let wordsToShow = selectedRange === 'all' ? words : getAvailableWords(selectedRange);

    wordsToShow.forEach(word => {
        const row = tableBody.insertRow();
        
        headers.forEach(header => {
            const cell = row.insertCell();
            let content = '';

            // æ ¹æ“šä¸åŒçš„å¯èƒ½çš„æ¨™é¡Œåç¨±ä¾†ç²å–å…§å®¹
            if (header === 'æ—¥æœŸ' || header === 'åˆ†é¡') content = word.date;
            else if (header === 'è‹±æ–‡' || header === 'English' || header === 'ENGLISH' || header === 'è‹±èª') content = word.english;
            else if (header === 'KKéŸ³æ¨™' || header === 'KK' || header === 'KK éŸ³æ¨™') content = word.kk;
            else if (header === 'ä¸­æ–‡é‡‹ç¾©' || header === 'ä¸­æ–‡' || header === 'Chinese' || header === 'chinese' || header === 'è¯èª') content = word.chinese;
            else if (header === 'è©æ€§') content = word.partOfSpeech; // å‡è¨­è©æ€§å­˜å„²åœ¨ partOfSpeech å±¬æ€§ä¸­
            else content = word[header.toLowerCase()] || ''; // for any other headers

            if (header === 'è‹±æ–‡' || header === 'English' || header === 'ENGLISH' || header === 'è‹±èª') {
                cell.innerHTML = colorizeEnglishWord(content);
                cell.className = 'clickable';
                cell.onclick = () => speakWord(content);
            } else if (header === 'KKéŸ³æ¨™' || header === 'KK' || header === 'KK éŸ³æ¨™') {
                cell.innerHTML = colorizeKKPhonetic(content);
                cell.className = 'clickable';
                cell.onclick = () => speakWord(word.english);
            } else {
                cell.textContent = content;
            }
        });
    });

    modal.style.display = 'block';
}

function closeWordList() {
    const modal = document.getElementById('word-list-modal');
    modal.style.display = 'none';
}

// ç•¶ç”¨æˆ¶é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨æ™‚é—œé–‰æ¨¡æ…‹æ¡†
window.onclick = function(event) {
    const modal = document.getElementById('word-list-modal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// æ›´æ–° updateSelectedRange å‡½æ•¸ä»¥åœ¨ç¯„åœæ”¹è®Šæ™‚åˆ·æ–°è©è¡¨
function updateSelectedRange() {
    selectedRange = document.getElementById('range-select').value;
    if (document.getElementById('word-list-modal').style.display === 'block') {
        showWordList(); // å¦‚æœè©è¡¨æ­£åœ¨é¡¯ç¤ºï¼Œå‰‡åˆ·æ–°å®ƒ
    }
}

    // åˆå§‹åŒ–
	parseData();
	populateDateDropdown();
	document.getElementById('show-custom-wordlist-btn').onclick = showCustomWordlist;


    </script>
</body>
</html>
